                unit: 'mm',
                format: [paperWidthMM, paperHeightMM]
            });
            
            // フォントサイズと行間を設定
            pdf.setFontSize(10);
            const lineHeight = 4;
            let yPosition = 10;
            
            // 日付・時刻を追加
            if (isDateTimeEnabled) {
                const now = new Date();
                const dateTimeText = formattedDate + ' ' + formattedTime;
                pdf.text(dateTimeText, 5, yPosition);
                yPosition += lineHeight + 2;
            }
            
            // テキストを行に分割して追加
            const lines = text.split('\n');
            for (let line of lines) {
                if (yPosition > paperHeightMM - 10) {
                    pdf.addPage([paperWidthMM, paperHeightMM]);
                    yPosition = 10;
                }
                pdf.text(line, 5, yPosition);
                yPosition += lineHeight;
            }
            
            // Base64でPDFデータを取得
            const pdfBase64 = pdf.output('datauristring').split(',')[1];
            resolve(pdfBase64);
        } catch (error) {
            reject(error);
        }
    });
}

function createPDFFromSignature(signatureDataUrl) {
    return new Promise((resolve, reject) => {
        try {
            const img = new Image();
            img.onload = function() {
                const paperWidthMM = 58;
                const paperHeightMM = Math.max(80, (img.naturalHeight / img.naturalWidth) * paperWidthMM);
                
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: [paperWidthMM, paperHeightMM]
                });
                
                // 署名をPDFに追加
                const imgWidthMM = paperWidthMM - 10;
                const imgHeightMM = (img.naturalHeight / img.naturalWidth) * imgWidthMM;
                const x = 5;
                const y = 5;
                
                pdf.addImage(signatureDataUrl, 'PNG', x, y, imgWidthMM, imgHeightMM);
                
                // Base64でPDFデータを取得
                const pdfBase64 = pdf.output('datauristring').split(',')[1];
                resolve(pdfBase64);
            };
            img.onerror = () => reject(new Error('署名の読み込みに失敗しました'));
            img.src = signatureDataUrl;
        } catch (error) {
            reject(error);
        }
    });
}

// ---- SII URL Print Agent用 PDF印刷関数 ----
function safeEncodeURIComponent(str) {
    return encodeURIComponent(str)
        .replace(/!/g, '%21')
        .replace(/'/g, '%27')
        .replace(/\(/g, '%28')
        .replace(/\)/g, '%29')
        .replace(/\*/g, '%2A')
        .replace(/%20/g, '%20');
}

// 画像印刷（PDF対応版）
function sendToPrintAssist(event) {
    event.preventDefault();
    let fileInput = document.getElementById('imageUpload');
    let file = fileInput.files[0];
    let imageDataUrl = null;
    let usePreview = false;
    
    if (!file && document.getElementById('imagePreviewContainer').firstChild && document.getElementById('imagePreviewContainer').firstChild.tagName === 'IMG') {
        let img = document.getElementById('imagePreviewContainer').firstChild;
        imageDataUrl = img.src;
        usePreview = true;
    }
    
    if ((!file && !usePreview) || selectedChip === '') return;
    
    const shrinkChecked = document.getElementById('shrinkCheckbox').checked;
    const selectedCopies = parseInt(document.getElementById('copiesSelect').value);
    
    async function doPrint(imageDataUrl) {
        try {
            const shrinkScale = shrinkChecked ? 0.6 : 1.0;
            const pdfBase64 = await createPDFFromImage(imageDataUrl, shrinkScale);
            
            // SII URL Scheme（PDF版）
            let url = "siiprintagent://1.0/print?";
            url += "CallbackSuccess=" + safeEncodeURIComponent(window.location.href) + "&";
            url += "CallbackFail=" + safeEncodeURIComponent(window.location.href) + "&";
            url += "Format=pdf&";
            url += "Data=" + safeEncodeURIComponent("data:application/pdf;base64," + pdfBase64) + "&";
            url += "PaperWidth=58";
            
            console.log("SII PRINT URL (PDF):", url);
            location.href = url;
            
            // 履歴に保存
            addHistory({
                type: 'image',
                mode: 'image',
                data: imageDataUrl,
                dateTime: selectedChip,
                copies: selectedCopies,
                shrink: shrinkChecked,
                created: Date.now()
            });
        } catch (error) {
            console.error('PDF生成エラー:', error);
            alert('PDF生成に失敗しました。もう一度お試しください。');
        }
    }
    
    if (usePreview) {
        doPrint(imageDataUrl);
    } else {
        const reader = new FileReader();
        reader.onloadend = function() {
            doPrint(reader.result);
        };
        reader.readAsDataURL(file);
    }
}

// テキスト印刷（PDF対応版）
function printText() {
    const textInput = document.getElementById('textInput');
    let text = textInput.value;
    if (text.trim() === '' || selectedTextChip === '') return;
    
    text = toZenkaku(text);
    const isDateTimeEnabled = selectedTextChip === 'with';
    const selectedTextCopies = parseInt(document.getElementById('textCopiesSelect').value);
    
    createPDFFromText(text, isDateTimeEnabled).then(pdfBase64 => {
        // SII URL Scheme（PDF版）
        let url = "siiprintagent://1.0/print?";
        url += "CallbackSuccess=" + safeEncodeURIComponent(window.location.href) + "&";
        url += "CallbackFail=" + safeEncodeURIComponent(window.location.href) + "&";
        url += "Format=pdf&";
        url += "Data=" + safeEncodeURIComponent("data:application/pdf;base64," + pdfBase64) + "&";
        url += "PaperWidth=58";
        
        console.log("SII PRINT URL (PDF):", url);
        location.href = url;
        
        // 履歴に保存
        addHistory({
            type: 'text',
            mode: 'text',
            data: textInput.value,
            dateTime: selectedTextChip,
            copies: selectedTextCopies,
            created: Date.now()
        });
    }).catch(error => {
        console.error('PDF生成エラー:', error);
        alert('PDF生成に失敗しました。もう一度お試しください。');
    });
}

// --- テキスト自動改行 用 ---
function wrapText(text) {
    text = toZenkaku(text);
    const lines = [];
    const paragraphs = text.split('\n');
    for (let paragraph of paragraphs) {
        if (paragraph.length === 0) {
            lines.push('');
            continue;
        }
        let remainingText = paragraph;
        while (remainingText.length > 0) {
            let lineLength = 0;
            let currentLine = '';
            let hasFullWidth = false;
            let hasHalfWidth = false;
            for (let i = 0; i < remainingText.length; i++) {
                const char = remainingText[i];
                const isFullWidth = char.match(/[^\x01-\x7E]/) ? true : false;
                const charWidth = isFullWidth ? 2 : 1;
                if (isFullWidth) hasFullWidth = true;
                else hasHalfWidth = true;
                let maxLen;
                if (hasFullWidth && hasHalfWidth) {
                    maxLen = 14;
                } else if (hasFullWidth) {
                    maxLen = 16;
                } else {
                    maxLen = 23;
                }
                if ((hasFullWidth && hasHalfWidth && currentLine.length >= maxLen) ||
                    (!hasFullWidth && !hasHalfWidth && currentLine.length >= maxLen) ||
                    (hasFullWidth && !hasHalfWidth && currentLine.length >= maxLen) ||
                    (!hasFullWidth && hasHalfWidth && currentLine.length >= maxLen)) {
                    break;
                }
                if ((hasFullWidth && hasHalfWidth && lineLength + charWidth > maxLen * 2) ||
                    (!hasFullWidth && !hasHalfWidth && lineLength + charWidth > maxLen) ||
                    (hasFullWidth && !hasHalfWidth && lineLength + charWidth > maxLen * 2) ||
                    (!hasFullWidth && hasHalfWidth && lineLength + charWidth > maxLen)) {
                    break;
                }
                currentLine += char;
                lineLength += charWidth;
            }
            lines.push(currentLine);
            remainingText = remainingText.substring(currentLine.length);
        }
    }
    return lines;
}

function toggleClearButton() {
    const textInput = document.getElementById('textInput');
    const clearTextButton = document.getElementById('clearTextButton');
    if (textInput.value.trim() !== '') {
        clearTextButton.style.display = 'block';
    } else {
        clearTextButton.style.display = 'none';
    }
}

function handleClearButtonClick() {
    const textInput = document.getElementById('textInput');
    const confirmClear = confirm('テキストをクリアしますか？');
    if (confirmClear) {
        textInput.value = '';
        document.getElementById('clearTextButton').style.display = 'none';
        updateTextPrintButtonState();
    }
}

function autoWrap(textarea) {
    const text = textarea.value;
    const wrappedLines = wrapText(text);
    textarea.value = wrappedLines.join('\n');
}

// イベントリスナーの設定
window.onload = function() {
    displayDate();
    updateTime();
    setModeToggle(currentHistoryType);
    
    // ファイル入力のイベントリスナー
    document.getElementById('imageUpload').addEventListener('change', previewImage);
    
    // チップクリックのイベントリスナー
    document.getElementById('chipWith').addEventListener('click', () => selectChip('with'));
    document.getElementById('chipWithout').addEventListener('click', () => selectChip('without'));
    document.getElementById('textChipWith').addEventListener('click', () => selectTextChip('with'));
    document.getElementById('textChipWithout').addEventListener('click', () => selectTextChip('without'));
    document.getElementById('signatureChipWith').addEventListener('click', () => selectSignatureChip('with'));
    document.getElementById('signatureChipWithout').addEventListener('click', () => selectSignatureChip('without'));
    
    // 印刷ボタンのイベントリスナー
    document.getElementById('printButton').addEventListener('click', sendToPrintAssist);
    document.getElementById('textPrintButton').addEventListener('click', printText);
    
    // 手書きサイン印刷ボタンのイベントリスナー
    document.getElementById('signaturePrintButton').addEventListener('click', async function() {
        if (!signaturePad || (signaturePad.isEmpty() && (!signaturePad._data || signaturePad._data.length === 0)) || selectedSignatureChip === '') return;
        
        try {
            const canvas = document.getElementById('signaturePad');
            const signatureDataUrl = canvas.toDataURL("image/png");
            const selectedCopies = parseInt(document.getElementById('signatureCopiesSelect').value);
            
            const pdfBase64 = await createPDFFromSignature(signatureDataUrl);
            
            // SII URL Scheme（PDF版）
            let url = "siiprintagent://1.0/print?";
            url += "CallbackSuccess=" + safeEncodeURIComponent(window.location.href) + "&";
            url += "CallbackFail=" + safeEncodeURIComponent(window.location.href) + "&";
            url += "Format=pdf&";
            url += "Data=" + safeEncodeURIComponent("data:application/pdf;base64," + pdfBase64) + "&";
            url += "PaperWidth=58";
            
            console.log("SII PRINT URL (PDF):", url);
            location.href = url;
            
            // 履歴に保存
            addHistory({
                type: 'signature',
                mode: 'signature',
                data: signatureDataUrl,
                dateTime: selectedSignatureChip,
                copies: selectedCopies,
                created: Date.now()
            });
        } catch (error) {
            console.error('PDF生成エラー:', error);
            alert('PDF生成に失敗しました。もう一度お試しください。');
        }
    });
    
    // テキスト関連のイベントリスナー
    document.getElementById('textInput').addEventListener('input', updateTextPrintButtonState);
    document.getElementById('textInput').addEventListener('input', toggleClearButton);
    document.getElementById('clearTextButton').addEventListener('click', handleClearButtonClick);
    document.getElementById('textInput').addEventListener('input', function() {
        autoWrap(this);
    });
    
    setTextChipsEnabled(false);
    loadHistoryList();
    initSignaturePad();
};

// Service Worker登録（オフライン対応）
if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
        navigator.serviceWorker.register('service-worker.js').then(function(registration) {
            console.log('Service Worker登録成功:', registration);
        }).catch(function(error) {
            console.log('Service Worker登録失敗:', error);
        });
    });
}
</script>
</body>
</html>
