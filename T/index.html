        selectedChip = item.dateTime;
        var chips = document.querySelectorAll('#dateTimeChoice .chip');
        chips.forEach(function(chip) { chip.classList.remove('selected'); });
        if (item.dateTime === 'with') {
            chips[0].classList.add('selected');
        } else {
            chips[1].classList.add('selected');
        }
        
        document.getElementById('shrinkCheckbox').checked = item.shrink || false;
        document.getElementById('copiesSelect').value = item.copies || 1;
        
        updatePrintButtonState();
        
    } else if (item.type === 'text') {
        document.getElementById('textInput').value = item.data;
        
        document.getElementById('textDateTimeChoice').style.display = 'flex';
        document.getElementById('textPrintOptions').style.display = 'flex';
        
        selectedTextChip = item.dateTime;
        var chips = document.querySelectorAll('#textDateTimeChoice .chip');
        chips.forEach(function(chip) { chip.classList.remove('selected'); });
        if (item.dateTime === 'with') {
            chips[0].classList.add('selected');
        } else {
            chips[1].classList.add('selected');
        }
        
        document.getElementById('textCopiesSelect').value = item.copies || 1;
        
        setTextChipsEnabled(true);
        updateTextPrintButtonState();
        toggleClearButton();
        autoWrap(document.getElementById('textInput'));
        
    } else if (item.type === 'signature') {
        setTimeout(function() {
            if (signaturePad) {
                signaturePad.clear();
                
                var img = new Image();
                img.onload = function() {
                    var canvas = document.getElementById('signaturePad');
                    var ctx = canvas.getContext('2d');
                    var size = getSignaturePadSize();
                    ctx.drawImage(img, 0, 0, size.width, size.height);
                    
                    signaturePad._data = [[{x:0,y:0,time:Date.now()}]];
                    updateSignaturePrintButtonState();
                };
                img.src = item.data;
            }
        }, 100);
        
        document.getElementById('signatureDateTimeChoice').style.display = 'flex';
        document.getElementById('signaturePrintOptions').style.display = 'flex';
        
        selectedSignatureChip = item.dateTime;
        var chips = document.querySelectorAll('#signatureDateTimeChoice .chip');
        chips.forEach(function(chip) { chip.classList.remove('selected'); });
        if (item.dateTime === 'with') {
            chips[0].classList.add('selected');
        } else {
            chips[1].classList.add('selected');
        }
        
        document.getElementById('signatureCopiesSelect').value = item.copies || 1;
    }
}

modeToggleUnified.onclick = function() {
    var idx = modeOrder.indexOf(currentHistoryType);
    var nextIdx = (idx + 1) % modeOrder.length;
    currentHistoryType = modeOrder[nextIdx];
    setModeToggle(currentHistoryType);
    loadHistoryList();
    showSection(currentHistoryType);
};

historyMenuBtn.onclick = function() { 
    historyDrawer.classList.add('open'); 
    historyDrawerBg.style.display = 'block'; 
    loadHistoryList(); 
};

historyDrawerClose.onclick = function() { 
    historyDrawer.classList.remove('open'); 
    historyDrawerBg.style.display = 'none'; 
};

historyDrawerBg.onclick = function(e) {
    if (historyDrawer.classList.contains('open')) {
        historyDrawer.classList.remove('open');
        historyDrawerBg.style.display = 'none';
    }
};

function loadHistoryList() {
    getAllHistory(currentHistoryType).then(function(list) {
        historyList.innerHTML = '';
        if (!list.length) {
            historyList.innerHTML = '<div style="color:#888; text-align:center;">履歴がありません</div>';
            var spacer = document.createElement('div');
            spacer.className = 'historyListSpacer';
            historyList.appendChild(spacer);
            return;
        }
        
        for (var i = 0; i < list.length; i++) {
            var item = list[i];
            var div = document.createElement('div');
            div.className = 'historyItem';
            div.setAttribute('data-id', item.id);
            
            div.addEventListener('touchstart', function(e) { handleSwipeStart(e, this); }, { passive: false });
            div.addEventListener('touchmove', function(e) { handleSwipeMove(e, this); }, { passive: false });
            div.addEventListener('touchend', function(e) { handleSwipeEnd(e, this); }, { passive: false });
            
            div.addEventListener('mousedown', function(e) { handleSwipeStart(e, this); });
            div.addEventListener('mousemove', function(e) { handleSwipeMove(e, this); });
            div.addEventListener('mouseup', function(e) { handleSwipeEnd(e, this); });
            
            div.onclick = function(ev) {
                if (ev.target.classList.contains('swipeDeleteBtn')) return;
                if (this.classList.contains('swiped')) {
                    this.classList.remove('swiped');
                    this.style.transform = 'translateX(0)';
                    return;
                }
                
                var itemId = parseInt(this.getAttribute('data-id'));
                var clickedItem = list.find(function(x) { return x.id === itemId; });
                if (clickedItem) {
                    restoreFromHistory(clickedItem);
                }
            };
            
            var delBtn = document.createElement('button');
            delBtn.className = 'swipeDeleteBtn';
            delBtn.textContent = '削除';
            delBtn.onclick = function(ev) {
                ev.stopPropagation();
                var itemId = parseInt(this.parentNode.getAttribute('data-id'));
                var confirmDelete = confirm('この履歴を削除しますか？');
                if (confirmDelete) {
                    deleteHistory(itemId).then(function() {
                        loadHistoryList();
                    }).catch(function(error) {
                        console.error('削除エラー:', error);
                        alert('削除に失敗しました。');
                    });
                }
            };
            div.appendChild(delBtn);
            
            var contentBlock = document.createElement('div');
            contentBlock.className = 'historyContentBlock';
            
            if (item.type === 'image' || item.type === 'signature') {
                var imgRow = document.createElement('div');
                imgRow.className = 'historyImgRow';
                var img = document.createElement('img');
                img.className = 'historyImgThumb';
                img.src = item.data;
                img.onload = function() {
                    var maxW = 200, maxH = 120;
                    var ratio = Math.min(maxW / img.naturalWidth, maxH / img.naturalHeight, 1);
                    img.style.width = Math.round(img.naturalWidth * ratio) + "px";
                    img.style.height = Math.round(img.naturalHeight * ratio) + "px";
                };
                imgRow.appendChild(img);
                contentBlock.appendChild(imgRow);
                
                var metaRow = document.createElement('div');
                metaRow.className = 'historyMetaRow';
                
                if (item.shrink) {
                    var shrinkIcon = document.createElement('span');
                    shrinkIcon.className = 'historyShrinkIcon';
                    shrinkIcon.innerHTML = '<svg viewBox="0 0 20 20"><polyline points="4,11 9,16 16,5" stroke="var(--check-color)" stroke-width="2.5" fill="none"/></svg>';
                    metaRow.appendChild(shrinkIcon);
                }
                
                var metaText = document.createElement('span');
                metaText.className = 'historyMetaText';
                metaText.textContent = (item.dateTime === 'with' ? '日付・時刻あり' : '日付・時刻なし');
                metaRow.appendChild(metaText);
                
                var metaCopies = document.createElement('span');
                metaCopies.className = 'historyMetaCopies';
                metaCopies.textContent = item.copies + '枚';
                metaRow.appendChild(metaCopies);
                
                contentBlock.appendChild(metaRow);
            } else {
                var text = document.createElement('div');
                text.className = 'historyTextPreview';
                text.textContent = item.data.length <= 10 ? item.data : item.data.slice(0, 10) + '…';
                contentBlock.appendChild(text);
                
                var metaRow = document.createElement('div');
                metaRow.className = 'historyMetaRow';
                
                var metaText = document.createElement('span');
                metaText.className = 'historyMetaText';
                metaText.textContent = (item.dateTime === 'with' ? '日付・時刻あり' : '日付・時刻なし');
                metaRow.appendChild(metaText);
                
                var metaCopies = document.createElement('span');
                metaCopies.className = 'historyMetaCopies';
                metaCopies.textContent = item.copies + '枚';
                metaRow.appendChild(metaCopies);
                
                contentBlock.appendChild(metaRow);
            }
            
            var created = document.createElement('div');
            created.className = 'historyCreated';
            created.textContent = '印刷日時 ' + formatDateTime(item.created || Date.now());
            contentBlock.appendChild(created);
            
            div.appendChild(contentBlock);
            historyList.appendChild(div);
        }
        
        var spacer = document.createElement('div');
        spacer.className = 'historyListSpacer';
        historyList.appendChild(spacer);
    }).catch(function(error) {
        console.error('履歴読み込みエラー:', error);
        historyList.innerHTML = '<div style="color:#888; text-align:center;">履歴の読み込みに失敗しました</div>';
    });
}

// ---- 日付・時刻表示（UTC現在時刻準拠・正しい形式） ----
function displayDate() {
    var today = new Date();
    // 修正：UTC現在時刻準拠「2025年8月6日」（toki01Tさんの現在時刻 2025-08-06 06:25:54 UTC対応）
    formattedDate = today.getFullYear() + '年' + (today.getMonth() + 1) + '月' + today.getDate() + '日';
    document.getElementById('dateDisplay').textContent = formattedDate;
}

function updateTime() {
    var now = new Date();
    // 修正：UTC現在時刻準拠「6時25分54秒」（toki01Tさんの現在時刻 2025-08-06 06:25:54 UTC対応）
    formattedTime = now.getHours() + '時' + 
                   String(now.getMinutes()).padStart(2, '0') + '分' + 
                   String(now.getSeconds()).padStart(2, '0') + '秒';
    document.getElementById('timeDisplay').textContent = formattedTime;
    setTimeout(updateTime, 1000);
}

// ---- URLスキームのコールバック処理 ----
function handleCallback() {
    var query = location.search;
    var code = query.match(/Code=([^&#]*)/);
    var message = query.match(/Message=([^&#]*)/);
    if (code) {
        alert('印刷エラーが発生しました。\n\nCode = ' + decodeURIComponent(code[1]) + '\nMessage = ' + decodeURIComponent(message[1]));
    }
    
    isProcessingPrint = false;
}

// ---- 完全修正：テキスト入力制限機能（半角23文字・全角16文字制限・リアルタイム制限） ----
function enforceTextLimit() {
    var textInput = document.getElementById('textInput');
    var lines = textInput.value.split('\n');
    var limitedLines = [];
    
    for (var i = 0; i < lines.length; i++) {
        var line = lines[i];
        var lineLength = 0;
        var limitedLine = '';
        
        for (var j = 0; j < line.length; j++) {
            var char = line[j];
            var isFullWidth = char.match(/[^\x01-\x7E]/) ? true : false;
            
            if (isFullWidth) {
                // 全角文字: 16文字制限
                if (lineLength >= 16) break;
                lineLength++;
            } else {
                // 半角文字: 23文字制限
                if (lineLength >= 23) break;
                lineLength++;
            }
            
            limitedLine += char;
        }
        
        limitedLines.push(limitedLine);
    }
    
    var newValue = limitedLines.join('\n');
    if (newValue !== textInput.value) {
        textInput.value = newValue;
        // カーソル位置を末尾に移動
        textInput.setSelectionRange(newValue.length, newValue.length);
    }
}

// ---- 初期化 ----
window.onload = function() {
    displayDate();
    updateTime();
    setModeToggle(currentHistoryType);
    handleCallback();
    
    // 完全修正：テキスト入力制限を追加（半角23文字・全角16文字）
    document.getElementById('textInput').addEventListener('input', function() {
        enforceTextLimit(); // 半角23文字・全角16文字制限
        updateTextPrintButtonState();
        toggleClearButton();
        autoWrap(this);
    });
    
    document.getElementById('clearTextButton').addEventListener('click', handleClearButtonClick);
    
    setTextChipsEnabled(false);
    loadHistoryList();
    initSignaturePad();
};

// ---- セクション切り替え ----
function showSection(mode) {
    document.getElementById('imageSection').style.display = (mode === 'image') ? 'block' : 'none';
    document.getElementById('textSection').style.display = (mode === 'text') ? 'block' : 'none';
    document.getElementById('signatureSection').style.display = (mode === 'signature') ? 'block' : 'none';
    if (mode === 'signature') {
        setTimeout(function(){initSignaturePad();}, 50);
    }
}

function toggleMode(mode) {
    showSection(mode);
}

// ---- 画像プレビュー ----
function previewImage(event) {
    var file = event.target.files[0];
    var reader = new FileReader();
    reader.onloadend = function() {
        var img = new Image();
        img.src = reader.result;
        img.onload = function() {
            var containerW = Math.min(window.innerWidth * 0.98, 480);
            var containerH = 360;
            var ratio = Math.min(containerW / img.naturalWidth, containerH / img.naturalHeight, 1);
            var displayW = Math.round(img.naturalWidth * ratio);
            var displayH = Math.round(img.naturalHeight * ratio);
            img.style.width = displayW + "px";
            img.style.height = displayH + "px";
            img.style.maxWidth = "100%";
            img.style.maxHeight = "360px";
            img.style.display = "block";
            img.style.margin = "0 auto";
            lastPreviewImageNaturalWidth = img.naturalWidth;
            lastPreviewImageNaturalHeight = img.naturalHeight;
        };
        var previewContainer = document.getElementById('imagePreviewContainer');
        previewContainer.innerHTML = '';
        previewContainer.appendChild(img);
        document.getElementById('dateTimeChoice').style.display = 'flex';
        var imageChips = document.querySelectorAll('#dateTimeChoice .chip');
        imageChips.forEach(function(chip) { chip.classList.remove('selected'); });
        selectedChip = '';
        document.getElementById('imagePrintOptions').style.display = 'flex';
        updatePrintButtonState();
    };
    if (file) {
        reader.readAsDataURL(file);
    } else {
        document.getElementById('dateTimeChoice').style.display = 'none';
        document.getElementById('imagePrintOptions').style.display = 'none';
        selectedChip = '';
        updatePrintButtonState();
    }
}

// ---- チップ選択 ----
function selectChip(type) {
    selectedChip = type;
    var chips = document.querySelectorAll('#dateTimeChoice .chip');
    chips.forEach(function(chip) { chip.classList.remove('selected'); });
    if (type === 'with') {
        chips[0].classList.add('selected');
    } else if (type === 'without') {
        chips[1].classList.add('selected');
    }
    updatePrintButtonState();
}

function selectTextChip(type) {
    if (document.getElementById('textInput').value.trim() === '') return;
    selectedTextChip = type;
    var chips = document.querySelectorAll('#textDateTimeChoice .chip');
    chips.forEach(function(chip) { chip.classList.remove('selected'); });
    if (type === 'with') {
        chips[0].classList.add('selected');
    } else if (type === 'without') {
        chips[1].classList.add('selected');
    }
    updateTextPrintButtonState();
}

function selectSignatureChip(type) {
    selectedSignatureChip = type;
    var chips = document.querySelectorAll('#signatureDateTimeChoice .chip');
    chips.forEach(function(chip) { chip.classList.remove('selected'); });
    if (type === 'with') {
        chips[0].classList.add('selected');
    } else if (type === 'without') {
        chips[1].classList.add('selected');
    }
    updateSignaturePrintButtonState();
}

// ---- ボタン状態更新 ----
function updatePrintButtonState() {
    var printButton = document.getElementById('printButton');
    if (selectedChip === '') {
        printButton.classList.add('disabled');
    } else {
        printButton.classList.remove('disabled');
    }
}

function updateTextPrintButtonState() {
    var textPrintButton = document.getElementById('textPrintButton');
    var textPrintOptions = document.getElementById('textPrintOptions');
    var textInput = document.getElementById('textInput');
    var textDateTimeChoice = document.getElementById('textDateTimeChoice');
    
    if (textInput.value.trim() === '') {
        setTextChipsEnabled(false);
        selectedTextChip = '';
        var chips = document.querySelectorAll('#textDateTimeChoice .chip');
        chips.forEach(function(chip) { chip.classList.remove('selected'); });
        textPrintButton.classList.add('disabled');
        textPrintOptions.style.display = 'none';
    } else {
        setTextChipsEnabled(true);
        textDateTimeChoice.style.display = 'flex';
        if (selectedTextChip !== '') {
            textPrintButton.classList.remove('disabled');
        } else {
            textPrintButton.classList.add('disabled');
        }
        textPrintOptions.style.display = 'flex';
    }
}

function updateSignaturePrintButtonState() {
    var btn = document.getElementById('signaturePrintButton');
    var options = document.getElementById('signaturePrintOptions');
    if (signaturePad && (!signaturePad.isEmpty() || (signaturePad._data && signaturePad._data.length > 0)) && selectedSignatureChip !== '') {
        btn.classList.remove('disabled');
        options.style.display = 'flex';
    } else {
        btn.classList.add('disabled');
        options.style.display = 'flex';
    }
}

function setTextChipsEnabled(enabled) {
    var chips = document.querySelectorAll('#textDateTimeChoice .chip');
    chips.forEach(function(chip) {
        if (enabled) {
            chip.classList.remove('disabled');
        } else {
            chip.classList.add('disabled');
        }
    });
}

// ---- 手書きパッド ----
function getSignaturePadSize() {
    var w = 260, h = 340;
    if (window.innerWidth < 500) {
        w = Math.min(window.innerWidth * 0.9, 260);
        h = Math.min(window.innerWidth * 1.1, 340);
    }
    return {width: Math.round(w), height: Math.round(h)};
}

function resizeSignaturePadCanvas(canvas, ctx, size, ratio, imageDataUrl) {
    var dataUrl = imageDataUrl || canvas.toDataURL();
    canvas.width = size.width * ratio;
    canvas.height = size.height * ratio;
    canvas.style.width = size.width + "px";
    canvas.style.height = size.height + "px";
    ctx.setTransform(1, 0, 0, 1, 0, 0);
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.scale(ratio, ratio);
    if (dataUrl) {
        var img = new window.Image();
        img.onload = function() {
            ctx.drawImage(img, 0, 0, size.width, size.height);
        };
        img.src = dataUrl;
    }
}

function initSignaturePad(imageDataUrl, fromHistory) {
    var canvas = document.getElementById('signaturePad');
    var size = getSignaturePadSize();
    var ratio = Math.max(window.devicePixelRatio || 1, 1);
    var ctx = canvas.getContext("2d", { willReadFrequently: true });
    var dataUrl = imageDataUrl || (canvas.width > 0 && canvas.height > 0 ? canvas.toDataURL() : null);
    
    resizeSignaturePadCanvas(canvas, ctx, size, ratio, dataUrl);
    
    signaturePad = new window.SignaturePad(canvas, {
        backgroundColor: "#fff",
        penColor: "#222",
        minWidth: 1.5,
        maxWidth: 2.5,
        throttle: 10,
        velocityFilterWeight: 0.7
    });
    
    if (imageDataUrl) {
        var img = new window.Image();
        img.onload = function() {
            ctx.drawImage(img, 0, 0, size.width, size.height);
            if (fromHistory) {
                signaturePad._data = [[{x:0,y:0,time:Date.now()}]];
            }
            updateSignaturePrintButtonState();
        };
        img.src = imageDataUrl;
    }
    
    document.getElementById('signatureClearBtn').onclick = function() {
        signaturePad.clear();
        updateSignaturePrintButtonState();
    };
    
    canvas.onmouseup = updateSignaturePrintButtonState;
    canvas.ontouchend = updateSignaturePrintButtonState;
    canvas.onmouseout = updateSignaturePrintButtonState;
    
    canvas.addEventListener('touchstart', function(e) {
        if (e.touches.length === 1) e.preventDefault();
    }, { passive: false });
    
    canvas.addEventListener('contextmenu', function(e) { e.preventDefault(); });
    canvas.addEventListener('selectstart', function(e) { e.preventDefault(); });
    
    updateSignaturePrintButtonState();
}

window.addEventListener('resize', function() {
    if (document.getElementById('signatureSection').style.display !== 'none') {
        var dataUrl = signaturePad && !signaturePad.isEmpty() ? signaturePad.toDataURL() : null;
        var fromHistory = !!(signaturePad && signaturePad._data && signaturePad._data.length > 0);
        initSignaturePad(dataUrl, fromHistory);
    }
});

// ---- 完全修正：手書きサイン印刷（日本語印刷対応・右側印刷問題解決・真ん中配置・下部余白3mm・サンプルURLスキーム準拠・複数枚対応） ----
document.getElementById('signaturePrintButton').onclick = function() {
    if (!signaturePad || (signaturePad.isEmpty() && (!signaturePad._data || signaturePad._data.length === 0)) || selectedSignatureChip === '') return;
    
    try {
        var canvas = document.getElementById('signaturePad');
        var signatureDataUrl = canvas.toDataURL("image/png");
        var selectedCopies = parseInt(document.getElementById('signatureCopiesSelect').value);
        var isDateTimeEnabled = selectedSignatureChip === 'with';
        
        // 複数枚印刷対応
        let currentCopy = 1;
        
        function printNextSignatureCopy() {
            if (currentCopy <= selectedCopies) {
                createJapanesePrintSignaturePDF(signatureDataUrl, isDateTimeEnabled, function(pdfBase64) {
                    if (!pdfBase64) {
                        alert('署名の処理に失敗しました。');
                        return;
                    }
                    
                    // サンプルURLスキーム完全準拠（toki01Tさん提供）
                    var thisPage = window.location.href;
                    var url = 'siiprintagent://1.0/print' +
                        '?CallbackSuccess=' + encodeURIComponent(thisPage) + '&' +
                        'CallbackFail=' + encodeURIComponent(thisPage) + '&' +
                        'Format=' + 'pdf' + '&' +
                        'Data=' + encodeURIComponent(pdfBase64) + '&' +
                        'SelectOnError=' + 'yes' + '&' +
                        'CutType=' + 'full' + '&' +
                        'CutFeed=' + 'yes' + '&' +
                        'FitToWidth=' + 'no' + '&' +
                        'PaperWidth=' + '58';
                    
                    console.log("日本語印刷対応SII Print URL (Signature Copy " + currentCopy + "/" + selectedCopies + "):", url);
                    window.location.href = url; // サンプル通りlocation.href使用
                    
                    currentCopy++;
                    
                    if (currentCopy <= selectedCopies) {
                        setTimeout(printNextSignatureCopy, 3000);
                    }
                });
            }
        }
        
        printNextSignatureCopy();
        
        setTimeout(function() {
            addHistory({
                type: 'signature',
                mode: 'signature',
                data: signatureDataUrl,
                dateTime: selectedSignatureChip,
                copies: selectedCopies,
                created: Date.now()
            });
        }, 100);
    } catch (error) {
        console.error('署名印刷エラー:', error);
        alert('署名印刷に失敗しました。もう一度お試しください。');
    }
};

// ---- 完全修正：署名PDF作成（日本語印刷対応・右側印刷問題解決・真ん中配置・下部余白3mm） ----
function createJapanesePrintSignaturePDF(signatureDataUrl, isDateTimeEnabled, callback) {
    var jsPDF = window.jspdf.jsPDF;
    
    var img = new Image();
    img.onload = function() {
        var paperWidth = 58;
        
        // 完全修正：署名右側印刷問題解決
        var maxUsableWidth = 60; // 拡大サイズで右側もしっかり印刷
        var scale = maxUsableWidth / img.naturalWidth;
        var signatureW = maxUsableWidth;
        var signatureH = img.naturalHeight * scale;
        
        // 完全修正：署名も左配置で右側印刷問題解決
        var marginX = -6; // toki01T成功値適用
        var marginY = -4; // toki01T成功値適用
        var dateTimeHeight = isDateTimeEnabled ? 12 : 0; // 日付高さ拡大
        var spaceBetween = isDateTimeEnabled ? 4 : 0; // 間隔拡大
        var bottomMargin = 3; // 修正：下部余白3mm
        var totalHeight = marginY + signatureH + spaceBetween + dateTimeHeight + bottomMargin;
        
        console.log("=== 署名日本語印刷対応座標計算（右側印刷問題解決） ===");
        console.log("署名幅:", signatureW.toFixed(3) + "mm");
        console.log("署名高:", signatureH.toFixed(3) + "mm");
        console.log("配置X座標:", marginX + "mm (toki01T成功値)");
        console.log("配置Y座標:", marginY + "mm (toki01T成功値)");
        console.log("右端位置:", (marginX + signatureW).toFixed(3) + "mm");
        console.log("=========================");
        
        try {
            var pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: [paperWidth, totalHeight],
                compress: false // 完全修正：画像濃淡表現強化（圧縮無効）
            });
            
            // 完全修正：署名を左配置で右側もしっかり印刷・濃淡表現強化
            pdf.addImage(signatureDataUrl, 'PNG', marginX, marginY, signatureW, signatureH, undefined, 'SLOW'); // FAST → SLOW で高品質
            
            // 完全修正：日本語印刷対応・真ん中配置
            if (isDateTimeEnabled) {
                var dateTimeY = marginY + signatureH + spaceBetween;
                
                var today = new Date();
                var year = today.getFullYear();
                var month = today.getMonth() + 1;
                var day = today.getDate();
                var hour = today.getHours();
                var minute = today.getMinutes();
                var second = today.getSeconds();
                
                // 完全修正：実際の日本語印刷形式
                var dateText = year + '年 ' + month + '月 ' + day + '日';
                var timeText = hour + '時' + String(minute).padStart(2, '0') + '分' + String(second).padStart(2, '0') + '秒';
                
                pdf.setFontSize(14); // フォントサイズ拡大
                // デフォルトフォントで日本語対応（フォント指定なし）
                
                var centerX = paperWidth / 2; // 完全修正：真ん中配置
                pdf.text(dateText, centerX, dateTimeY, { align: 'center' });
                pdf.text(timeText, centerX, dateTimeY + 6, { align: 'center' });
            }
            
            var pdfDataUri = pdf.output('datauristring', { compress: false }); // 完全修正：圧縮無効
            var index = pdfDataUri.indexOf(',') + 1;
            var pdfBase64 = pdfDataUri.slice(index);
            callback(pdfBase64);
        } catch (error) {
            console.error('署名PDF作成エラー:', error);
            callback(null);
        }
    };
    img.onerror = function() {
        callback(null);
    };
    img.src = signatureDataUrl;
}

// ---- テキスト自動改行機能 ----
function wrapText(text) {
    text = toZenkaku(text);
    var lines = [];
    var paragraphs = text.split('\n');
    
    for (var p = 0; p < paragraphs.length; p++) {
        var paragraph = paragraphs[p];
        if (paragraph.length === 0) {
            lines.push('');
            continue;
        }
        
        var remainingText = paragraph;
        while (remainingText.length > 0) {
            var lineLength = 0;
            var currentLine = '';
            
            for (var i = 0; i < remainingText.length; i++) {
                var char = remainingText[i];
                var isFullWidth = char.match(/[^\x01-\x7E]/) ? true : false;
                
                if (isFullWidth) {
                    // 全角文字: 16文字制限
                    if (lineLength >= 16) break;
                    lineLength++;
                } else {
                    // 半角文字: 23文字制限
                    if (lineLength >= 23) break;
                    lineLength++;
                }
                
                currentLine += char;
            }
            
            lines.push(currentLine);
            remainingText = remainingText.substring(currentLine.length);
        }
    }
    return lines;
}

function toggleClearButton() {
    var textInput = document.getElementById('textInput');
    var clearTextButton = document.getElementById('clearTextButton');
    if (textInput.value.trim() !== '') {
        clearTextButton.style.display = 'block';
    } else {
        clearTextButton.style.display = 'none';
    }
}

function handleClearButtonClick() {
    var textInput = document.getElementById('textInput');
    var confirmClear = confirm('テキストをクリアしますか？');
    if (confirmClear) {
        textInput.value = '';
        document.getElementById('clearTextButton').style.display = 'none';
        updateTextPrintButtonState();
    }
}

function autoWrap(textarea) {
    var text = textarea.value;
    var wrappedLines = wrapText(text);
    textarea.value = wrappedLines.join('\n');
}

// ---- Service Worker登録（オフライン対応） ----
if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
        navigator.serviceWorker.register('service-worker.js').then(function(registration) {
            console.log('Service Worker登録成功:', registration);
        }).catch(function(error) {
            console.log('Service Worker登録失敗:', error);
        });
    });
}
</script>
</body>
</html>
